<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Contador de Prazos C√≠veis ‚Äî TJGO (2023‚Äì2026)</title>
  <style>
    :root{
      --paper:#f8f6f2; --paper-3:#eee9e1; --card:#ffffff;
      --ink:#2b2b2b; --sepia:#7a6f61; --graphite:#3a3a3a;
      --line:#e3ded6; --line-2:#d8d1c4;
      --useful:#4d6b4d; --holiday:#7a6f61; --recess:#6a1f1f; --ash:#8a6d3b;
      --row:#fbf9f5; --row2:#f5f1ea; --hl:#f1ede5; --bad:var(--recess);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--paper); color:var(--ink);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      padding:0;
    }

    /* Header responsivo */
    header{
      background:var(--graphite); color:#fff;
      padding:20px 16px;
      position:sticky;
      top:0;
      z-index:20;
      box-shadow:0 2px 10px rgba(0,0,0,.15);
    }
    header h1{
      margin:0 0 8px; 
      font-weight:800;
      font-size:1.4rem;
    }
    header .legal{
      margin-top:10px; 
      font-size:.9rem; 
      line-height:1.35; 
      opacity:.94;
    }
    .legal-toggle{
      display:inline-block;
      margin-top:8px;
      padding:6px 10px;
      background:rgba(255,255,255,.15);
      border-radius:6px;
      font-size:.85rem;
      cursor:pointer;
    }

    /* Menu m√≥vel */
    #mobile-menu{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:var(--graphite);
      display:flex;
      justify-content:space-around;
      padding:10px 0;
      z-index:30;
      box-shadow:0 -2px 10px rgba(0,0,0,.15);
    }
    #mobile-menu a, #mobile-menu button{
      display:flex;
      flex-direction:column;
      align-items:center;
      background:none;
      border:none;
      color:white;
      font-size:.8rem;
      padding:8px 12px;
      text-decoration:none;
      border-radius:8px;
      transition:background .2s;
    }
    #mobile-menu a:hover, #mobile-menu button:hover{
      background:rgba(255,255,255,.12);
    }
    #mobile-menu .icon{
      font-size:1.2rem;
      margin-bottom:4px;
    }

    main{
      max-width:100%;
      margin:0 auto 80px;  
      padding:16px;
    }
    .card{
      background:var(--card); 
      border-radius:16px; 
      border:1px solid var(--line);
      box-shadow:0 5px 15px rgba(2,12,27,.06); 
      padding:16px;
      margin-bottom:16px;
    }
    .grid{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    @media (min-width: 768px) {
      .grid{
        display:grid;
        grid-template-columns:1.1fr 1fr .9fr;
        gap:12px;
      }
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    label{
      font-size:.92rem; 
      color:#4a4743; 
      font-weight:600;
    }
    input[type="date"], select, input[type="number"]{
      width:100%; 
      padding:14px 16px; 
      border:1px solid #e5e1db; 
      border-radius:12px; 
      font-size:1rem;
      background:#fff; 
      outline:none;
      -webkit-appearance:none;
      min-height:50px;
    }

    .actions{
      display:flex; 
      flex-direction:column;
      gap:12px; 
      margin-top:16px;
    }
    @media (min-width: 480px) {
      .actions{
        flex-direction:row;
        align-items:center;
        flex-wrap:wrap;
      }
    }

    .btn{
      padding:14px 18px; 
      border-radius:12px; 
      cursor:pointer; 
      font-weight:700;
      border:1px solid transparent; 
      letter-spacing:.25px;
      font-size:1rem;
      min-height:50px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex:1;
    }
    .btn.primary{background:var(--graphite); color:#fff;}
    .btn.secondary{background:var(--sepia); color:#fff;}
    .btn.ghost{background:transparent; border:1px solid #d6d0c7; color:var(--ink)}
    .btn:hover{transform:translateY(-1px)}

    .chips{
      display:flex; 
      gap:8px; 
      flex-wrap:wrap;
      justify-content:center;
    }
    .chip{
      padding:12px 14px; 
      background:transparent; 
      border:1px solid #d6d0c7;
      border-radius:999px; 
      font-weight:700; 
      cursor:pointer; 
      font-size:.93rem;
      min-width:60px;
      text-align:center;
    }
    .chip:hover{background:var(--paper-3)}
    .chip[data-d="5"]{border-color:var(--ash); color:var(--ash)}
    .chip[data-d="15"]{border-color:var(--useful); color:var(--useful)}
    .chip[data-d="30"]{border-color:var(--useful); color:var(--ash)}

    .final-date{
      margin:16px 0 12px; 
      padding:16px; 
      background:var(--hl);
      border:1px dashed var(--line-2); 
      border-radius:12px; 
      font-weight:800;
      font-size:1.1rem;
      text-align:center;
    }
    
    /* Tabela responsiva */
    .table-container{
      max-height:400px; 
      overflow:auto; 
      margin-top:12px; 
      border:1px solid var(--line); 
      border-radius:12px; 
      background:#fff;
    }
    table{
      width:100%; 
      border-collapse:separate; 
      border-spacing:0; 
      font-size:.95rem;
      min-width:600px;
    }
    thead th{
      position:sticky; 
      top:0; 
      background:#fff; 
      z-index:2; 
      padding:12px 10px; 
      border-bottom:1px solid var(--line);
      font-size:.9rem;
    }
    tbody td{
      padding:12px 10px; 
      border-bottom:1px dashed #e7e2da;
      font-size:.9rem;
    }
    tbody tr:nth-child(odd){background:var(--row)}
    tbody tr:nth-child(even){background:var(--row2)}

    .tag{
      padding:6px 10px; 
      border-radius:999px; 
      font-weight:700; 
      font-size:.82rem; 
      display:inline-block; 
      border:1px solid transparent;
      white-space:nowrap;
    }
    .tag.ok{background:rgba(77,107,77,.1); color:var(--useful); border-color:rgba(77,107,77,.25)}
    .tag.warn{background:rgba(122,111,97,.1); color:var(--holiday); border-color:rgba(122,111,97,.25)}
    .tag.recesso{background:rgba(106,31,31,.1); color:var(--recess); border-color:rgba(106,31,31,.25)}
    .tag.info{background:rgba(138,109,59,.1); color:var(--ash); border-color:rgba(138,109,59,.25)}

    footer{
      max-width:100%; 
      margin:24px auto 100px; 
      padding:0 16px; 
      color:#6b655d; 
      font-size:.9rem;
    }
    .code{
      padding:4px 8px; 
      border-radius:6px; 
      border:1px solid var(--line); 
      background:#f4f1eb;
      font-family:monospace;
    }
    .danger{color:var(--recess); font-weight:800}

    /* Modal para informa√ß√µes legais */
    .modal{
      display:none;
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,.7);
      z-index:40;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .modal-content{
      background:var(--card);
      border-radius:16px;
      padding:24px;
      max-width:500px;
      width:100%;
      max-height:80vh;
      overflow-y:auto;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
    }
    .modal-close{
      background:none;
      border:none;
      font-size:1.5rem;
      cursor:pointer;
      color:var(--sepia);
    }
  </style>
</head>
<body>

<header>
  <h1>Contador de Prazos C√≠veis ‚Äî TJGO</h1>
  <p class="legal">
    <strong>Leitura</strong>: contagem no primeiro dia √∫til subsequente.<br>
    <strong>Expedi√ß√£o</strong>: D1/D2; contagem no dia √∫til subsequente √† publica√ß√£o (D2).<br>
    <strong>Quarta-Feira de Cinzas (QF)</strong>: n√£o se inicia nem termina; conta-se durante o curso.<br>
    <strong>Recesso</strong>: 20/12 a 20/01 (inclusive); aplica-se somente dia √∫til.
  </p>
  <div class="legal-toggle" id="toggleLegal">‚ÑπÔ∏è Mais informa√ß√µes</div>
</header>

<main>
  <section class="card">
    <div class="grid">
      <div class="field">
        <label for="tipo">Tipo de marco inicial</label>
        <select id="tipo">
          <option value="leitura">Leitura (intima√ß√£o lida)</option>
          <option value="expedicao">Expedi√ß√£o (Dia em que o ato foi gerado no Projudi)</option>
        </select>
      </div>

      <div class="field">
        <label for="dataBase">Data Inicial</label>
        <input type="date" id="dataBase" />
      </div>

      <div class="field">
        <label for="dias">Dias de prazo (dias √∫teis)</label>
        <input type="number" id="dias" min="1" step="1" value="15"/>
      </div>
    </div>

    <div class="actions">
      <button class="btn primary" id="btnCalcular">Calcular prazo</button>
      <div class="chips">
        <button class="chip" data-d="5">5 dias</button>
        <button class="chip" data-d="15">15 dias</button>
        <button class="chip" data-d="30">30 dias</button>
      </div>
    </div>
    <div style="margin-top:12px; font-size:.9rem; color:#7a6f61; text-align:center;">
      Feriados TJGO (2023‚Äì2026), recesso (20/12‚Äì20/01), fins de semana e Quarta-feira de Cinzas com regra especial j√° aplicados.
    </div>

    <div class="result" id="resultado" style="display:none">
      <div class="final-date" id="finalDate"></div>
      <div class="actions">
        <button class="btn secondary" id="btnCopiar">Copiar resumo</button>
        <button class="btn ghost" id="btnCSV">Exportar CSV</button>
      </div>
      <div class="table-container">
        <table id="tabela">
          <thead>
            <tr>
              <th>#</th>
              <th>Data</th>
              <th>Dia</th>
              <th>Tipo</th>
              <th>Observa√ß√£o</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p style="margin-top:12px; font-size:.85rem; color:#7a6f61; text-align:center;">
        Planilha de auditoria cont√≠nua: todos os dias entre o marco e a data final s√£o listados, com justificativa quando n√£o contados.
      </p>
    </div>
  </section>
</main>

<footer>
  <p><strong>Fontes oficiais:</strong> Feriados do Tribunal de Justi√ßa do Estado de Goi√°s (2023‚Äì2026) e Recesso Forense, conforme calend√°rios publicados. Este utilit√°rio n√£o substitui a confer√™ncia oficial nos autos e normativos aplic√°veis.</p>
</footer>

<!-- Menu m√≥vel -->
<div id="mobile-menu">
  <a href="index.html">
    <span class="icon">üè†</span>
    <span>In√≠cio</span>
  </a>
  <button id="mobileCalc">
    <span class="icon">üìÖ</span>
    <span>Calcular</span>
  </button>
  <button id="mobileCopy">
    <span class="icon">üìã</span>
    <span>Copiar</span>
  </button>
  <button id="mobileExport">
    <span class="icon">üì§</span>
    <span>Exportar</span>
  </button>
</div>

<!-- Modal para informa√ß√µes legais -->
<div class="modal" id="legalModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 style="margin:0;">Informa√ß√µes Legais</h2>
      <button class="modal-close" id="closeModal">&times;</button>
    </div>
    <div>
      <p><strong>Leitura</strong>: contagem no primeiro dia √∫til subsequente.</p>
      <p><strong>Expedi√ß√£o</strong>: D1/D2; contagem no dia √∫til subsequente √† publica√ß√£o (D2).</p>
      <p><strong>Quarta-Feira de Cinzas (QF)</strong>: n√£o se inicia nem termina; conta-se durante o curso.</p>
      <p><strong>Recesso</strong>: 20/12 a 20/01 (inclusive); aplica-se somente dia √∫til.</p>
      <p><strong>Feriados TJGO</strong>: Incluem feriados nacionais, estaduais e municipais conforme calend√°rio oficial do TJGO.</p>
    </div>
  </div>
</div>

<script>
  // ---------- Utilidades de datas ----------
  const fmtBR = (d)=>{
    const pad = (n)=> String(n).padStart(2,'0');
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
  };
  const diaSemana = (d)=>["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"][d.getDay()];
  const ymd = (d)=>{
    const pad=(n)=> String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  };
  const parseISO = (s)=>{
    const [Y,M,D] = s.split('-').map(Number);
    const dt = new Date(Date.UTC(Y, M-1, D));
    return new Date(dt.getUTCFullYear(), dt.getUTCMonth(), dt.getUTCDate());
  };
  const addDays = (d, n)=>{
    const nd = new Date(d);
    nd.setDate(nd.getDate()+n);
    return nd;
  };

  // ---------- Base de feriados TJGO (2023-2026) ----------
  const HOLIDAYS = new Map(); // key: 'YYYY-MM-DD' ‚Üí {name, yearTag}
  const ASH = new Set(); // Quarta-Feira de Cinzas (datas espec√≠ficas)

  function add(name, dates, {ash=false}={}) {
    dates.forEach(s=> {
      HOLIDAYS.set(s, {name, yearTag: s.slice(0,4)});
      if(ash) ASH.add(s);
    });
  }
  function addRange(name, fromYMD, toYMD){
    let d = parseISO(fromYMD);
    const end = parseISO(toYMD);
    while(d <= end){
      HOLIDAYS.set(ymd(d), {name, yearTag: d.getFullYear().toString()});
      d = addDays(d, 1);
    }
  }

  // 2023
  add("Confraterniza√ß√£o Universal (Feriado Nacional)", ["2023-01-01"]);
  add("Carnaval (Feriado no Tribunal e em todas as comarcas)", ["2023-02-20","2023-02-21"]);
  add("Quarta-feira de Cinzas (regra especial)", ["2023-02-22"], {ash:true});
  add("Semana Santa ‚Äî Feriado no Tribunal", ["2023-04-05","2023-04-06"]);
  add("Paix√£o de Cristo (Feriado Nacional)", ["2023-04-07"]);
  add("Tiradentes (Feriado Nacional)", ["2023-04-21"]);
  add("Dia do Trabalho (Feriado Nacional)", ["2023-05-01"]);
  add("Nossa Senhora Auxiliadora (Feriado Municipal: Goi√¢nia, Ipor√°, Leopoldo de Bulh√µes, Senador Canedo)", ["2023-05-24"]);
  add("Corpus Christi (Feriado Nacional)", ["2023-06-08"]);
  add("Funda√ß√£o da Cidade de Goi√°s (Feriado no Tribunal)", ["2023-07-26"]);
  add("Independ√™ncia do Brasil (Feriado Nacional)", ["2023-09-07"]);
  add("Nossa Senhora Aparecida (Feriado Nacional)", ["2023-10-12"]);
  add("Comemorativo pedra fundamental/Anivers√°rio de Goi√¢nia (Feriado no Tribunal)", ["2023-10-24"]);
  add("Dia do Servidor P√∫blico (Feriado Estadual)", ["2023-10-28"]);
  add("Finados (Feriado Nacional)", ["2023-11-02"]);
  add("Proclama√ß√£o da Rep√∫blica (Feriado Nacional)", ["2023-11-15"]);
  add("Dia da Justi√ßa (Feriado no Tribunal)", ["2023-12-08"]);
  add("Natal (Feriado Nacional)", ["2023-12-25"]);
  addRange("Recesso Forense", "2023-12-20", "2024-01-20");

  // 2024
  add("Ano Novo (Feriado Nacional)", ["2024-01-01"]);
  add("Carnaval (Feriado no Tribunal e em todas as comarcas)", ["2024-02-12","2024-02-13"]);
  add("Quarta-feira de Cinzas (regra especial)", ["2024-02-14"], {ash:true});
  add("Semana Santa ‚Äî Feriado no Tribunal", ["2024-03-27","2024-03-28","2024-03-29"]);
  add("Dia do Trabalho (Feriado Nacional)", ["2024-05-01"]);
  add("Nossa Senhora Auxiliadora (Feriado Municipal: TJ/Comarcas espec√≠ficas)", ["2024-05-24"]);
  add("Corpus Christi (Feriado Nacional)", ["2024-05-30"]);
  add("Ponto Facultativo ‚Äî PJ estadual", ["2024-05-31"]);
  add("Funda√ß√£o da Cidade de Goi√°s (feriado de 26/07 alterado para 22/07)", ["2024-07-22"]);
  add("Anivers√°rio de Goi√¢nia (Feriado no Tribunal e em todas as comarcas)", ["2024-10-24"]);
  add("Dia do Servidor P√∫blico (feriado do dia 28/10 alterado para 01/11)", ["2024-11-01"]);
  add("Proclama√ß√£o da Rep√∫blica (Feriado Nacional)", ["2024-11-15"]);
  add("Dia da Consci√™ncia Negra (Feriado Nacional)", ["2024-11-20"]);
  add("Natal (Feriado Nacional)", ["2024-12-25"]);
  addRange("Recesso Forense", "2024-12-20", "2025-01-20");

  // 2025
  add("Ano Novo (Feriado Nacional)", ["2025-01-01"]);
  add("Carnaval (Feriado no Tribunal e em todas as comarcas)", ["2025-03-03","2025-03-04"]);
  add("Quarta-feira de Cinzas (regra especial)", ["2025-03-05"], {ash:true});
  add("Semana Santa ‚Äî Feriado no Tribunal", ["2025-04-16","2025-04-17","2025-04-18"]);
  add("Tiradentes (Feriado Nacional)", ["2025-04-21"]);
  add("Dia do Trabalho (Feriado Nacional)", ["2025-05-01"]);
  add("Nossa Senhora Auxiliadora (Feriado Municipal: TJ/Comarcas espec√≠ficas)", ["2025-05-24"]);
  add("Corpus Christi (Feriado Nacional)", ["2025-06-19"]);
  add("Funda√ß√£o da Cidade de Goi√°s (Feriado no Tribunal)", ["2025-07-26"]);
  add("Independ√™ncia do Brasil (Feriado Nacional)", ["2025-09-07"]);
  add("Nossa Senhora Aparecida (Feriado Nacional)", ["2025-10-12"]);
  add("Anivers√°rio de Goi√¢nia (Feriado no Tribunal e em todas as comarcas)", ["2025-10-24"]);
  add("Dia do Servidor P√∫blico (Feriado Estadual)", ["2025-10-28"]);
  add("Finados (Feriado Nacional)", ["2025-11-02"]);
  add("Proclama√ß√£o da Rep√∫blica (Feriado Nacional)", ["2025-11-15"]);
  add("Dia da Consci√™ncia Negra (Feriado Nacional)", ["2025-11-20"]);
  add("Dia da Justi√ßa (Feriado ‚Äî Art. 123 RITJGO)", ["2025-12-08"]);
  add("Natal (Feriado Nacional)", ["2025-12-25"]);
  addRange("Recesso Forense", "2025-12-20", "2026-01-20");

  // 2026 (incluso para cobertura)
  add("Ano Novo (Feriado Nacional)", ["2026-01-01"]);
  add("Carnaval (Feriado no Tribunal e em todas as comarcas)", ["2026-02-16","2026-02-17"]);
  add("Quarta-feira de Cinzas (regra especial)", ["2026-02-18"], {ash:true});
  add("Semana Santa ‚Äî Feriado no Tribunal", ["2026-04-03","2026-04-04","2026-04-05"]);
  add("Tiradentes (Feriado Nacional)", ["2026-04-21"]);
  add("Dia do Trabalho (Feriado Nacional)", ["2026-05-01"]);
  addRange("Recesso Forense", "2026-12-20", "2027-01-20"); // apenas placeholder caso necess√°rio

  // ---------- Helpers ----------
  function isWeekend(d){ const g = d.getDay(); return g===0 || g===6; }
  function isAshWednesday(d){ return ASH.has(ymd(d)); }
  function holidayInfo(d){ const k=ymd(d); return HOLIDAYS.get(k) || null; }

  // mode: 'counting' (contagem em curso, QF conta) | 'start_end' (in√≠cio/fim, QF bloqueia)
  function isHoliday(d, mode='counting'){
    const info = holidayInfo(d);
    if(info){
      if(isAshWednesday(d)){
        return mode === 'start_end' ? info : null;
      }
      return info;
    }
    return null;
  }

  function isBusinessDay(d, mode='counting'){
    if(isWeekend(d)) return false;
    const h = isHoliday(d, mode);
    if(h) return false;
    return true;
  }
  function nextBusinessDay(d, mode='counting'){
    let cur = new Date(d);
    while(!isBusinessDay(cur, mode)) cur = addDays(cur,1);
    return cur;
  }

  function reasonNonUseful(d, mode='counting'){
    // Prioridade: Recesso > Feriado > QF(start_end) > Fim de semana
    const h = holidayInfo(d);
    if(h){
      if(h.name.toLowerCase().includes('recesso')) return 'Recesso forense';
      if(isAshWednesday(d) && mode==='start_end') return 'QF ‚Äî n√£o inicia/n√£o finaliza';
      return `Feriado ‚Äî ${h.name}`;
    }
    if(isWeekend(d)) return 'Fim de semana';
    if(isAshWednesday(d) && mode==='start_end') return 'QF ‚Äî n√£o inicia/n√£o finaliza';
    return '';
  }

  function classifyDay(d, mode='counting'){
    const obj = {date: new Date(d), dow: diaSemana(d), tag: '', badge:'', obs:[], final:false};

    // Fim de semana
    if(isWeekend(d)){
      obj.tag='N√£o √∫til'; obj.badge='warn';
      obj.obs.push('Fim de semana');
      return obj;
    }

    // Feriados e recesso
    const h = isHoliday(d, mode);
    if(h){
      const isRec = h.name.toLowerCase().includes('recesso');
      obj.tag = isRec ? 'Recesso' : 'N√£o √∫til';
      obj.badge = isRec ? 'recesso' : 'warn';
      obj.obs.push(isRec ? 'Recesso forense' : h.name);
      if(isAshWednesday(d) && mode==='start_end'){ obj.obs = ['QF ‚Äî n√£o inicia/n√£o finaliza']; obj.badge='info'; }
      return obj;
    }

    // Quarta-feira de Cinzas ‚Äî durante contagem √© √∫til
    if(isAshWednesday(d) && mode==='counting'){
      obj.tag='√ötil'; obj.badge='info'; obj.obs.push('QF ‚Äî contado (contagem em curso)');
      return obj;
    }

    obj.tag='√ötil'; obj.badge='ok';
    return obj;
  }

  // Conta N dias √∫teis; aplica prorroga√ß√£o se final cair em QF (n√£o pode finalizar)
  function addBusinessDays(start, n, firstDayNote=null){
    let cur = new Date(start);
    let count = 0;
    const counted = new Map(); // ymd -> obs array
    while(count < n){
      cur = addDays(cur, 1);
      if(isBusinessDay(cur, 'counting')){
        count++;
        const obs = [`Dia √∫til de contagem #${count}`];
        if(count === 1 && firstDayNote){ obs[0] += ` (${firstDayNote})`; }
        if(count === n){ obs.push('Data te√≥rica final do prazo'); }
        counted.set(ymd(cur), obs);
      }
    }
    // Se final cair em QF (start_end), prorroga para pr√≥ximo √∫til
    if(isAshWednesday(cur)){
      const key = ymd(cur);
      if(counted.has(key)) counted.get(key).push('QF ‚Äî n√£o finaliza; prorrogado');
      let bump = nextBusinessDay(addDays(cur,1), 'start_end');
      counted.set(ymd(bump), ['Prorroga√ß√£o da final por QF ‚Üí Data final']);
      cur = bump;
    } else {
      const key = ymd(cur);
      if(counted.has(key)) counted.get(key).push('Data final do prazo');
      else counted.set(key, ['Data final do prazo']);
    }
    return {end: cur, counted};
  }

  // ---------- Regras espec√≠ficas para publica√ß√£o (D1/D2) ----------
  function isRecessDay(d){
    const h = holidayInfo(d);
    return !!(h && h.name.toLowerCase().includes('recesso'));
  }

  // Mapa de observa√ß√µes de publica√ß√£o (datas ‚Üí array de anota√ß√µes)
  function pushNote(map, d, txt){
    const k = ymd(d);
    if(!map.has(k)) map.set(k, []);
    map.get(k).push(txt);
  }

  // Pr√≥ximo dia de publica√ß√£o a partir do dia anterior (marco ou D1)
  // Regra h√≠brida: aceita dia √∫til normal OU dia √∫til de recesso; rejeita FDS e feriado n√£o-recesso
  function nextPublicationFrom(prevDate, pubIndex, pubLog){
    let d = addDays(prevDate, 1);
    while(true){
      const wknd = isWeekend(d);
      const h = holidayInfo(d);
      const rec = isRecessDay(d);

      // S√°bado/Domingo sempre rejeitados para publica√ß√£o (mesmo se dentro do recesso)
      if(wknd){
        // Observa√ß√£o jur√≠dica padronizada
        pushNote(pubLog, d, 'ato de publica√ß√£o n√£o se realiza em finais de semana.');
        d = addDays(d, 1);
        continue;
      }

      // Feriado n√£o-recesso rejeitado
      if(h && !rec && !isAshWednesday(d)){
        pushNote(pubLog, d, `ato de publica√ß√£o n√£o se realiza em feriados ‚Äî ${h.name}.`);
        d = addDays(d, 1);
        continue;
      }

      // Se chegou aqui: dia √∫til normal OU dia √∫til de recesso OU QF (tratada abaixo)
      // Observa√ß√µes de aceita√ß√£o: registrar Publica√ß√£o Dn
      pushNote(pubLog, d, `Publica√ß√£o D${pubIndex} (${pubIndex===1 ? '1¬∫' : '2¬∫'} dia √∫til ap√≥s expedi√ß√£o)`);
      return d;
    }
  }

  // ---------- Principal ----------
  document.querySelectorAll('.chip').forEach(ch => {
    ch.addEventListener('click', ()=>{
      document.getElementById('dias').value = ch.dataset.d;
    });
  });

  function calcularPrazo() {
    const tipo = document.getElementById('tipo').value;
    const sData = document.getElementById('dataBase').value;
    const nDias = parseInt(document.getElementById('dias').value, 10);
    if(!sData || isNaN(nDias) || nDias<=0){
      alert('Informe a Data Inicial e um n√∫mero v√°lido de dias.');
      return;
    }

    const marco = parseISO(sData);
    let D1=null, D2=null, inicioContagem=null, firstNote=null;

    // PUB_NOTES guarda candidaturas rejeitadas/aceitas para auditoria
    const PUB_NOTES = new Map();

    if(tipo === 'leitura'){
      inicioContagem = nextBusinessDay(addDays(marco,1), 'start_end');
      firstNote = '1¬∫ dia √∫til ap√≥s leitura';
    } else {
      // Regras h√≠bridas para D1/D2 com auditoria de candidatos rejeitados
      D1 = nextPublicationFrom(marco, 1, PUB_NOTES);
      D2 = nextPublicationFrom(D1,    2, PUB_NOTES);

      // In√≠cio da contagem: 1¬∫ dia √∫til ap√≥s D2 (respeitando recesso, feriados, QF)
      inicioContagem = nextBusinessDay(addDays(D2,1), 'start_end');
      firstNote = 'dia √∫til subsequente √† publica√ß√£o D2';
    }

    const {end: dataFinal, counted} = addBusinessDays(addDays(inicioContagem,-1), nDias, firstNote);

    // --- Montar auditoria cont√≠nua ---
    const tbody = document.querySelector('#tabela tbody');
    tbody.innerHTML = '';
    let idx = 0;

    let cursor = new Date(marco);
    const endInclusive = new Date(dataFinal);

    while(cursor <= endInclusive){
      idx++;
      const key = ymd(cursor);
      const isMarco = (key === ymd(marco));
      let mode = (cursor < inicioContagem) ? 'start_end' : 'counting';

      const base = classifyDay(cursor, mode);
      const obsParts = [];

      // Observa√ß√£o base para n√£o √∫til (prioridade)
      if(base.tag === 'N√£o √∫til'){
        let reason = reasonNonUseful(cursor, mode);
        if(isMarco){
          const marcoTxt = (tipo==='leitura')?'Dia da leitura':'Dia da expedi√ß√£o';
          const isRecesso = (reason.toLowerCase().includes('recesso'));
          if(isRecesso){
            reason = 'Recesso forense ‚Äî ' + marcoTxt;
            obsParts.push(reason);
          } else {
            obsParts.push(marcoTxt);
          }
        } else {
          obsParts.push(reason);
        }
      }

      // D1 / D2 (publica√ß√£o): notas detalhadas (inclui candidatos rejeitados)
      if(PUB_NOTES && PUB_NOTES.has(key)){
        obsParts.push(...PUB_NOTES.get(key));
      }

      // Dias √∫teis contados
      if(counted.has(key)){
        base.tag = '√ötil'; base.badge='ok';
        obsParts.push(...counted.get(key));
      }else{
        //
      }

      // Render
      const tr = document.createElement('tr');
      const tdIdx = document.createElement('td'); tdIdx.textContent = idx;
      const tdData = document.createElement('td'); tdData.textContent = fmtBR(base.date);
      const tdDow  = document.createElement('td'); tdDow.textContent = base.dow;

      // badge: ok | warn | recesso | info
      const tdTag  = document.createElement('td'); tdTag.innerHTML = `<span class="tag ${base.badge}">${base.tag}</span>`;
      const tdObs  = document.createElement('td'); tdObs.textContent = obsParts.join(' ‚Ä¢ ');
      tr.append(tdIdx, tdData, tdDow, tdTag, tdObs);

      if(key === ymd(dataFinal)) tr.style.outline = '2px solid var(--bad)';
      tbody.appendChild(tr);

      cursor = addDays(cursor,1);
    }

    document.getElementById('finalDate').innerHTML =
      `Prazo de <span class="code">${nDias}</span> dias √∫teis ‚Äî <strong>data final:</strong> <span class="danger">${fmtBR(dataFinal)}</span>`;
    document.getElementById('resultado').style.display = 'block';

    // Copiar resumo / CSV
    document.getElementById('btnCopiar').onclick = ()=>{
      const resumo = [
        `Tipo: ${tipo === 'leitura' ? 'Leitura' : 'Expedi√ß√£o'}`,
        `Data Inicial: ${fmtBR(marco)}`,
        `Dias de prazo: ${nDias}`,
        `Data final: ${fmtBR(dataFinal)}`
      ].join('\n');
      navigator.clipboard.writeText(resumo).then(()=> alert('Resumo copiado.'));
    };

    document.getElementById('btnCSV').onclick = ()=>{
      const linhas = [["#", "Data", "Dia da semana", "Classifica√ß√£o", "Observa√ß√£o"]];
      const trs = document.querySelectorAll('#tabela tbody tr');
      trs.forEach(tr=>{
        const tds = tr.querySelectorAll('td');
        const cols = [tds[0].textContent, tds[1].textContent, tds[2].textContent, tds[3].innerText, tds[4].textContent];
        linhas.push(cols);
      });
      const csv = linhas.map(cols=> cols.map(col=> `"${String(col).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'auditoria_prazo.csv';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };
  }

  document.getElementById('btnCalcular').addEventListener('click', calcularPrazo);

  // Menu m√≥vel - funcionalidades
  document.getElementById('mobileCalc').addEventListener('click', calcularPrazo);
  document.getElementById('mobileCopy').addEventListener('click', ()=>{
    document.getElementById('btnCopiar').click();
  });
  document.getElementById('mobileExport').addEventListener('click', ()=>{
    document.getElementById('btnCSV').click();
  });

  // Modal para informa√ß√µes legais
  document.getElementById('toggleLegal').addEventListener('click', ()=>{
    document.getElementById('legalModal').style.display = 'flex';
  });
  document.getElementById('closeModal').addEventListener('click', ()=>{
    document.getElementById('legalModal').style.display = 'none';
  });
  document.getElementById('legalModal').addEventListener('click', (e)=>{
    if(e.target === document.getElementById('legalModal')){
      document.getElementById('legalModal').style.display = 'none';
    }
  });

  // Melhorar a experi√™ncia em dispositivos m√≥veis
  // Definir data padr√£o como hoje
  const today = new Date();
  const todayFormatted = today.toISOString().split('T')[0];
  document.getElementById('dataBase').value = todayFormatted;
  
  // Melhorar a usabilidade do input de data em mobile
  document.getElementById('dataBase').addEventListener('focus', function() {
    this.type = 'date';
  });
</script>
  
</body>
</html>
