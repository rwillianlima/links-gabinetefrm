<script>
    // Variáveis globais
    let dataset = [];
    let filteredData = [];
    let currentSearchTerms = '';
    let currentPage = 1;
    const resultsPerPage = 50;

    // URLs das planilhas (inalteradas)
    const SPREADSHEET_BASE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTCwzKKtRs5uQ56A6GCx6FPVSKU8mTXxowFrVpJ1XjHLagJw-pA2ks46MO0b06TtEqZgbx7UJRvY1Hu/pub';
    
    // Configuração das bases (inalterada)
    const DATA_SOURCES = {
        '0': { name: 'Jurisprudência', gid: '0' },
        '2110972132': { name: 'Súmulas do TJGO', gid: '2110972132' },
        '1277187400': { name: 'Súmulas do STJ', gid: '1277187400' },
        '503544784': { name: 'Súmulas do STF', gid: '503544784' }
    };

    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
        // loadDataset(); // Linha removida! Os dados só carregam na busca.
        updateClock();
        setInterval(updateClock, 1000);
        
        // Estado inicial: 'Todas as Bases' está selecionado, então Relator deve estar desabilitado
        document.getElementById('relator').disabled = true;

        // Event listeners
        document.getElementById('terms').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') performSearch();
        });

        document.getElementById('dataSource').addEventListener('change', function() {
            const selectedValue = this.value;
            const relatorSelect = document.getElementById('relator');
            
            resetSearch();

            // Lógica para habilitar/desabilitar o Relator
            // Só habilita se 'Jurisprudência' (valor '0') for selecionado
            if (selectedValue === '0') {
                relatorSelect.disabled = false;
                loadDataset(); // Carrega os dados para preencher a lista de relatores
            } else {
                relatorSelect.value = ''; // Limpa o valor
                relatorSelect.disabled = true;
                // Para 'Todas as Bases' ou outras Súmulas, atualiza a interface sem carregar dados
                updateInterfaceForDataSource(selectedValue === '' ? 'all' : selectedValue);
                document.getElementById('datasetInfo').textContent = selectedValue === ''
                    ? 'Pronto para buscar em todas as bases simultaneamente'
                    : `Pronto para buscar em ${DATA_SOURCES[selectedValue].name}`;
                setSearchButtonState(false);
            }
        });

        setTimeout(() => document.getElementById('terms').focus(), 500);
    });

    // Funções de UI (Inalteradas, exceto se especificado)
    // ... (Manter toggleSidebar, updateClock, showAlert, setSearchButtonState)

    function updateInterfaceForDataSource(source) {
        const title = document.querySelector('h1');
        const subtitle = document.querySelector('.subtitle');
        const relatorSelect = document.getElementById('relator'); // Adicionado
        
        if (source === 'all') {
            title.textContent = 'Pesquisa Integrada';
            subtitle.textContent = 'Busca em todas as bases: Jurisprudência, Súmulas TJGO, STJ e STF';
            relatorSelect.disabled = true; // Garante que está desabilitado na busca integrada
        } else if (DATA_SOURCES[source]) {
            const sourceInfo = DATA_SOURCES[source];
            title.textContent = source === '0' ? 'Pesquisa de Jurisprudência' : 'Pesquisa de Súmulas';
            subtitle.textContent = sourceInfo.name;
            relatorSelect.disabled = source !== '0'; // Habilita SÓ para Jurisprudência
        }
    }
    
    // Funções de dados
    function loadDataset() {
        const dataSource = document.getElementById('dataSource').value;
        
        // Se for "Todas as Bases", não carrega dados aqui, apenas na busca
        if (dataSource === '') return;

        const sourceInfo = DATA_SOURCES[dataSource];
        const csvUrl = `${SPREADSHEET_BASE_URL}?gid=${sourceInfo.gid}&single=true&output=csv`;
        
        updateInterfaceForDataSource(dataSource);
        document.getElementById('datasetInfo').textContent = `Carregando ${sourceInfo.name}...`;
        setSearchButtonState(true, 'Carregando dados...');
        
        Papa.parse(csvUrl, {
            download: true,
            header: true,
            complete: function(results) {
                if (results.errors?.length > 0) {
                    handleDataError('Erro na formatação dos dados');
                    return;
                }
                
                // Armazena no dataset global apenas se for para Jurisprudência
                dataset = results.data.filter(item => item && item.Processo);
                
                if (dataset.length === 0) {
                    handleDataError(`Nenhum dado encontrado em ${sourceInfo.name}`);
                    return;
                }
                
                updateDatasetInfo();
                populateFilters();
                setSearchButtonState(false);
                // NÂO exibe alerta, pois isso pode ser cansativo no carregamento
            },
            error: function(error) {
                handleDataError(`Erro ao carregar dados de ${sourceInfo.name}`);
                console.error('Erro detalhado:', error);
            }
        });
    }

    // ... (Manter handleDataError, updateDatasetInfo, formatDate, parseDate, populateFilters)

    // Funções de busca (Ajustadas para garantir que 'Todas as Bases' carregue tudo)
    function performSearch() {
        if (window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.remove('active');
        }

        const searchTerms = document.getElementById('terms').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const relator = document.getElementById('relator').value;
        const useFuzzy = document.getElementById('fuzzy').checked;
        const dataSource = document.getElementById('dataSource').value;
        
        // Validação
        if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
            showAlert('A data de início não pode ser maior que a data de fim.', 'error');
            return;
        }
        
        currentSearchTerms = searchTerms;
        setSearchButtonState(true);
        
        setTimeout(async () => {
            try {
                if (dataSource === '') {
                    // Busca em TODAS as bases (Súmulas e Jurisprudência)
                    filteredData = await searchAllDatabases(searchTerms, startDate, endDate, relator, useFuzzy);
                } else {
                    // Busca em uma ÚNICA base (dataset já carregado)
                    filteredData = filterSingleDataset(searchTerms, startDate, endDate, relator, useFuzzy, dataSource);
                }
                
                displayResults(filteredData);
                setSearchButtonState(false);
            } catch (error) {
                console.error('Erro na busca:', error);
                showAlert('Erro durante a busca. Tente novamente.', 'error');
                setSearchButtonState(false);
            }
        }, 100);
    }

    function filterSingleDataset(searchTerms, startDate, endDate, relator, useFuzzy, dataSource) {
        // Se for súmula, o dataset global é vazio (não precisa usar ele, mas o dataSource será usado no map)
        const dataToFilter = dataSource === '0' ? dataset : filteredData; 
        
        return dataToFilter.filter(item => {
            const isJurisprudencia = dataSource === '0';
            
            // Filtro de Relator: Só aplica se for Jurisprudência (Base '0')
            if (isJurisprudencia && relator && item.Relator !== relator) return false;
            
            // ... (restante da lógica de data e termos, inalterada)
            if (startDate || endDate) {
                const itemDate = parseDate(item.Publicação);
                if (!itemDate) return false;
                if (startDate && itemDate < new Date(startDate)) return false;
                if (endDate && itemDate > new Date(endDate)) return false;
            }
            
            if (searchTerms) {
                const searchText = `${item.Ementa || ''} ${item.Processo || ''}`.toLowerCase();
                return portugueseAdvancedSearch(searchText, searchTerms, useFuzzy);
            }
            
            return true;
        }).map(item => ({
            ...item,
            dataSource: dataSource,
            baseName: DATA_SOURCES[dataSource].name
        })).sort((a, b) => {
            const dateA = parseDate(a.Publicação) || new Date(0);
            const dateB = parseDate(b.Publicação) || new Date(0);
            return dateB - dateA;
        });
    }

    async function searchAllDatabases(searchTerms, startDate, endDate, relator, useFuzzy) {
        // Inverti a ordem para Jurisprudência primeiro (Base '0') - mais relevante para 6ª Câmara Cível
        const allGids = ['0', '2110972132', '1277187400', '503544784']; 
        let allResults = [];
        let loadedCount = 0;
        
        // Usei Promise.all para carregar as 4 bases em paralelo (mais rápido)
        const loadPromises = allGids.map(gid => loadSingleDataset(`${SPREADSHEET_BASE_URL}?gid=${gid}&single=true&output=csv`));
        
        setSearchButtonState(true, `Carregando bases...`);
        
        try {
            const allData = await Promise.all(loadPromises);
            
            allGids.forEach((gid, index) => {
                const data = allData[index];
                const isJurisprudencia = gid === '0';
                loadedCount++;
                setSearchButtonState(true, `Filtrando bases... (${loadedCount}/${allGids.length})`);

                const filtered = data.filter(item => {
                    // Filtro de Relator: SÓ aplica se for Jurisprudência (Base '0')
                    if (isJurisprudencia && relator && item.Relator !== relator) return false;
                    
                    if (startDate || endDate) {
                        const itemDate = parseDate(item.Publicação);
                        if (!itemDate) return false;
                        if (startDate && itemDate < new Date(startDate)) return false;
                        if (endDate && itemDate > new Date(endDate)) return false;
                    }
                    
                    if (searchTerms) {
                        const searchText = `${item.Ementa || ''} ${item.Processo || ''}`.toLowerCase();
                        return portugueseAdvancedSearch(searchText, searchTerms, useFuzzy);
                    }
                    
                    return true;
                }).map(item => ({
                    ...item,
                    dataSource: gid,
                    baseName: DATA_SOURCES[gid].name
                }));
                
                allResults = allResults.concat(filtered);
            });

        } catch (error) {
            console.error('Erro ao carregar ou filtrar bases:', error);
            throw new Error('Falha ao carregar uma ou mais bases de dados.');
        }
        
        // Ordenar por data (mais recente primeiro)
        return allResults.sort((a, b) => {
            const dateA = parseDate(a.Publicação) || new Date(0);
            const dateB = parseDate(b.Publicação) || new Date(0);
            return dateB - dateA;
        });
    }

    function loadSingleDataset(url) {
        return new Promise((resolve, reject) => {
            Papa.parse(url, {
                download: true,
                header: true,
                complete: function(results) {
                    if (results.errors?.length > 0) {
                        reject(new Error(results.errors.map(e => e.message).join(', ')));
                    } else {
                        resolve(results.data.filter(item => item && Object.keys(item).length > 0));
                    }
                },
                error: reject
            });
        });
    }

    // ... (Manter o restante das funções inalteradas: portugueseAdvancedSearch, createSearchRegex, fuzzyMatch, calculateSimilarity, editDistance, displayResults, createResultBlock, getTribunalName, extractSearchTerms, createAccentInsensitiveRegexString, highlightText, escapeRegex, createPagination, changePage, copyToClipboard, resetSearch)

</script>
