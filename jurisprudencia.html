<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Pesquisa de Jurisprud√™ncia ‚Äì Gabinete Des. F. R. Montefusco</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#174b73;color:#fff;margin:0;}
  /* Sidebar */
  #sidebar{position:fixed;top:0;left:0;width:240px;height:100%;background:#0b2f4d;box-shadow:2px 0 6px rgba(0,0,0,.3);}  
  #sidebar a{display:block;padding:12px 20px;color:#fff;text-decoration:none;font-size:1rem;}
  #sidebar a:hover{background:#105b8e;}
  /* Content */
  #content{margin-left:260px;padding:40px 25px;min-height:100vh;text-align:center;}
  #content h1{font-size:2rem;margin-bottom:8px;}
  .dataset-info{font-size:.92rem;color:#e0f2ff;margin:2px auto 18px auto;max-width:920px}
  .notice{font-size:.85rem;margin-bottom:6px;}
  /* Search */
  .search-bar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:10px;}
  .search-bar input,.search-bar select{padding:8px;border:none;border-radius:4px;width:200px;max-width:90%;}
  .search-bar button{padding:8px 18px;border:none;border-radius:4px;background:#0b2f4d;color:#fff;font-weight:bold;cursor:pointer;}
  .search-bar button:hover{background:#105b8e;}
  /* Help */
  .help{max-width:920px;margin:10px auto 0 auto;text-align:left;background:#0b2f4d;padding:12px 16px;border-radius:6px;font-size:.92rem;line-height:1.45}
  .help code{background:rgba(255,255,255,.1);padding:0 4px;border-radius:3px}
  .help summary{cursor:pointer;font-weight:700}
  /* Result count */
  #resultCount{font-size:.95rem;margin:10px auto;max-width:900px;text-align:left;color:#fff;display:none;}
  /* Blocks */
  .block{background:#0b2f4d;border-radius:6px;padding:16px;margin:10px auto;max-width:900px;display:none;position:relative;}
  .block p{margin:4px 0 0 0;font-size:.9rem;line-height:1.35;color:#fff;text-align:justify;}
  .type{margin-top:6px;font-size:.85rem;color:#cfd8dc;text-align:center;}
  .meta{margin-top:8px;font-size:.85rem;color:#cfd8dc;text-align:center;}
  /* Copy button (em cada bloco) */
  .copy-btn{position:absolute;top:10px;right:10px;border:none;border-radius:4px;padding:6px 10px;background:#17324d;color:#fff;cursor:pointer;font-size:.8rem}
  .copy-btn:hover{background:#105b8e;}
  /* Pagination */
  .pagination{display:none;justify-content:center;gap:6px;margin:20px auto;max-width:900px;flex-wrap:wrap}
  .pagination button{background:#0b2f4d;border:none;border-radius:4px;color:#fff;padding:6px 12px;cursor:pointer}
  .pagination button.active{background:#105b8e;font-weight:bold;}
  .pagination button[disabled]{opacity:.5;cursor:not-allowed}
  /* Cont√™iner de resultados (oculto at√© a busca) */
  #allBlocks{display:none;}
  /* Destaque dos termos encontrados */
  mark{
    background:#ffd54f;
    color:#17324d;
    font-weight:bold;
    padding:0 2px;
    border-radius:2px;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<div id="sidebar"><a href="index.html" rel="noopener noreferrer">üîô Voltar √† P√°gina Inicial</a></div>
<div id="content">
  <h1>üîé Pesquisa Avan√ßada de Jurisprud√™ncia</h1>
  <div id="datasetInfo" class="dataset-info">Carregando informa√ß√µes do banco de dados‚Ä¶</div>

  <p class="notice">Use <strong>aspas</strong> para frases exatas; <strong>;</strong> ou <strong>AND</strong> para termos obrigat√≥rios; <strong>OR</strong> para altern√¢ncia; <strong>-</strong> ou <strong>NOT</strong> para excluir; <strong>*</strong> como curinga. Acentos s√£o ignorados.</p>

  <!-- Ajuda ao usu√°rio -->
  <div class="help" id="helpBox">
    <details>
      <summary>Como pesquisar (clique para expandir)</summary>
      <div style="margin-top:10px">
        <p><strong>Aspas</strong>: <code>"frase exata"</code> ‚Äî ex.: <code>"a√ß√£o revisional"</code></p>
        <p><strong>AND</strong> (todos os termos): <code>termo1;termo2</code> ou <code>termo1 AND termo2</code></p>
        <p><strong>OR</strong> (altern√¢ncia): <code>cl√°usulaA OR cl√°usulaB</code></p>
        <p><strong>NOT</strong> (excluir): <code>-termo</code> ou <code>NOT termo</code> (aceita tamb√©m <code>-"frase exata"</code>)</p>
        <p><strong>Curinga *</strong> (prefixo/sufixo): <code>contrat*</code> encontra ‚Äúcontrato‚Äù, ‚Äúcontratual‚Äù; <code>"dano *"</code> encontra ‚Äúdano moral/material/...‚Äù.</p>
        <p><strong>Exemplos</strong>:</p>
        <ul style="margin:6px 0 0 18px">
          <li><code>"a√ß√£o revisional";plano</code> ‚Üí cont√©m a frase exata e ‚Äúplano‚Äù.</li>
          <li><code>"dano moral" OR "responsabilidade civil"</code> ‚Üí uma ou outra frase.</li>
          <li><code>ISS;-"fato gerador"</code> ‚Üí cont√©m ‚ÄúISS‚Äù e exclui a express√£o ‚Äúfato gerador‚Äù.</li>
          <li><code>segur*;regress*</code> ‚Üí aproxima√ß√µes por radical.</li>
          <li><code>"dano *"; BACEN</code> ‚Üí ‚Äúdano moral/material/‚Ä¶‚Äù e ‚ÄúBACEN‚Äù.</li>
        </ul>
        <p style="margin-top:8px;color:#cfd8dc">Dica: acentos s√£o ignorados. ‚Äúa√ß√£o‚Äù ‚â° ‚Äúacao‚Äù.</p>
      </div>
    </details>
  </div>

  <div class="search-bar">
    <input type="text" id="terms" placeholder="Ex.: &quot;dano *&quot; ; BACEN OR &quot;dano moral&quot; -&quot;fato gerador&quot;">
    <input type="date" id="startDate"><input type="date" id="endDate">
    <select id="relator"><option value="">Relator (todos)</option></select>
    <select id="camera"><option value="">C√¢mara (todas)</option></select>
    <select id="ato"><option value="">Ato (todos)</option></select>
    <button onclick="performSearch()">Consultar</button>
  </div>

  <div id="resultCount"></div>
  <div id="allBlocks"></div>
  <div id="pagination" class="pagination"></div>
</div>

<script>
const TSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTCwzKKtRs5uQ56A6GCx6FPVSKU8mTXxowFrVpJ1XjHLagJw-pA2ks46MO0b06TtEqZgbx7UJRvY1Hu/pub?gid=0&single=true&output=tsv';
const PAGE_SIZE = 50;
const MAX_PAGE_BUTTONS = 9;
let allBlocks = [], currentResults = [], currentPage = 1;

/* ---------- Utilidades ---------- */

/* dd/mm/aaaa ‚Üí aaaa-mm-dd */
function toISO(dmy) {
  const [d,m,y] = (dmy||'').split('/');
  return y ? `${y}-${m.padStart(2,'0')}-${d.padStart(2,'0')}` : '';
}

/* Remove 'Des.' / 'Desa.' no in√≠cio */
function cleanRelator(name) {
  return (name||'').replace(/^(des\.?\s+|desa\.?\s+)/i, '').trim();
}

/* Normaliza: min√∫sculas sem acentos */
function normalizeStr(s){
  return (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
}

/* Escapa metacaracteres de regex */
function escapeRegex(s){
  return s.replace(/[-/\\^$+?.()|[\]{}]/g, '\\$&');
}

/* ---------- Parser (AND/OR/NOT; curingas dentro e fora de aspas; robusto a \s) ---------- */
/**
 * Sa√≠da: array de cl√°usulas { must: [fn], not: [fn] }
 * - OR separa cl√°usulas (fora de aspas)
 * - ; ou AND separam termos (AND) dentro da cl√°usula
 * - "-" ou NOT no in√≠cio ‚Üí exclus√£o (NOT)
 * - Aspas para frase, aceita curinga * dentro de aspas ("dano *")
 * - Compara√ß√£o sempre sobre texto normalizado (sem acento)
 */
function parseSearchQuery(raw) {
  const clauses = [];
  if (!raw) return clauses;

  // Divide por OR (fora de aspas), aceitando qualquer whitespace ao redor
  const tokens = [];
  let buf = '', inQ = false;
  for (let i=0;i<raw.length;i++){
    const ch = raw[i];
    if (ch === '"'){ inQ = !inQ; buf += ch; continue; }
    if (!inQ){
      const m = raw.slice(i).match(/^\s+OR\s+/i);
      if (m){
        tokens.push(buf.trim());
        tokens.push('OR');
        buf = '';
        i += m[0].length - 1;
        continue;
      }
    }
    buf += ch;
  }
  if (buf.trim()) tokens.push(buf.trim());

  let current = { must: [], not: [] };

  const pushTerm = (rawPart) => {
    let part = rawPart.trim();
    if (!part) return;

    // Prefixos de nega√ß√£o
    let isNot = false;
    if (/^NOT\s+/i.test(part)) { isNot = true; part = part.replace(/^NOT\s+/i,'').trim(); }
    else if (part.startsWith('-')) { isNot = true; part = part.slice(1).trim(); }

    // Aspas (frase) ‚Äî mas aceitando curinga * dentro
    let inQuotes = false;
    if (part.startsWith('"') && part.endsWith('"') && part.length >= 2){
      inQuotes = true;
      part = part.slice(1,-1);
    }

    // Monta regex sobre TEXTO NORMALIZADO:
    // - Normaliza o termo
    // - Converte * ‚Üí coringa (qualquer sequ√™ncia)
    // - Converte espa√ßos ‚Üí \s+ (espa√ßos flex√≠veis)
    // - Escapa o restante
    const buildNormalizedRegex = (t) => {
      const norm = normalizeStr(t);
      // separa por '*' preservando ordem
      const chunks = norm.split('*').map(c => c.replace(/\s+/g, '\\s+').split('').map(ch => escapeRegex(ch)).join(''));
      // junta com coringa "qualquer coisa" (n√£o ganancioso)
      const body = chunks.join('[\\s\\S]*?');
      // caso especial: se o termo come√ßar com *, n√£o ancora no in√≠cio do trecho
      // aqui deixamos livre (substring), pois a busca √© ampla
      return new RegExp(body, 'i'); // i: case-insensitive (j√° normalizado)
    };

    const re = buildNormalizedRegex(part);

    // matcher: recebe TEXTO NORMALIZADO e aplica regex
    const matcher = (textNorm) => re.test(textNorm);
    matcher.__raw = part; // para destaque

    (isNot ? current.not : current.must).push(matcher);
  };

  const flushClause = () => {
    clauses.push(current);
    current = { must: [], not: [] };
  };

  tokens.forEach(tok=>{
    if (tok === 'OR'){
      if (current.must.length || current.not.length) flushClause();
    } else {
      // Dentro da cl√°usula, ; ou AND (fora de aspas), aceitando \s
      let partBuf = '', q = false;
      const parts = [];
      const pushBuf = ()=>{ if (partBuf.trim()) parts.push(partBuf.trim()); partBuf=''; };

      for (let i=0;i<tok.length;i++){
        const c = tok[i];
        if (c === '"'){ q=!q; partBuf+=c; continue; }
        if (!q && c === ';'){ pushBuf(); continue; }
        if (!q){
          const mAnd = tok.slice(i).match(/^\s+AND\s+/i);
          if (mAnd){ pushBuf(); i += mAnd[0].length - 1; continue; }
        }
        partBuf += c;
      }
      pushBuf();

      parts.forEach(pushTerm);
    }
  });
  if (current.must.length || current.not.length) flushClause();

  return clauses;
}

/* Extrai termos POSITIVOS para destaque; se houver '*', usa prefixo (antes do 1¬∫ '*') */
function extractTermsForHighlight(clauses){
  const terms = [];
  clauses.forEach(clause => {
    (clause.must || []).forEach(fn => {
      const raw = fn && fn.__raw ? String(fn.__raw) : '';
      if (!raw) return;
      const base = raw.includes('*') ? raw.split('*')[0] : raw;
      if (base && !terms.includes(base)) terms.push(base);
    });
  });
  return terms;
}

/* ---------- Copiar (ementa + meta) ---------- */
function getCopyText(block){
  const ementaEl = block.querySelector('p:nth-of-type(2)');
  const metaEl   = block.querySelector('.meta');
  const ementa = (ementaEl?.textContent || '').trim();
  const meta   = (metaEl?.textContent || '').trim();
  return `${ementa} ${meta}`.replace(/\s+/g,' ').replace(/\s+\)/,')').trim();
}

function attachCopyButton(block) {
  const btn = document.createElement('button');
  btn.className = 'copy-btn';
  btn.type = 'button';
  btn.title = 'Copiar este resultado';
  btn.setAttribute('aria-label', 'Copiar este resultado');
  btn.textContent = 'üìã Copiar';
  btn.addEventListener('click', async (e) => {
    e.stopPropagation();
    const text = getCopyText(block);
    try {
      await navigator.clipboard.writeText(text);
      const old = btn.textContent;
      btn.textContent = '‚úî Copiado';
      btn.disabled = true;
      setTimeout(()=>{ btn.textContent = old; btn.disabled = false; }, 1400);
    } catch {
      alert('N√£o foi poss√≠vel copiar automaticamente. Selecione e copie manualmente.');
    }
  });
  block.appendChild(btn);
}

/* ---------- Carregamento e montagem ---------- */
async function loadTSV() {
  try {
    const res = await fetch(TSV_URL);
    const text = await res.text();
    const rows = Papa.parse(text, { header: true, delimiter: '\t', skipEmptyLines: true }).data;

    // Coleta filtros e m√©tricas do dataset
    const relSet = new Set(), cameraSet = new Set(), atoSet = new Set();
    let totalPesquisaveis = 0;
    let maxDateISO = '';
    let maxDateBr = '';

    rows.forEach((r) => {
      const pub = (r['Publica√ß√£o'] || '').trim();
      const eme = (r.Ementa || '').trim();
      if (pub && eme) {
        totalPesquisaveis++;
        const iso = toISO(pub);
        if (iso && (!maxDateISO || iso > maxDateISO)) { maxDateISO = iso; maxDateBr = pub; }
      }
      if (r.Relator)    relSet.add(cleanRelator(r.Relator));
      if (r['C√¢mara'])  cameraSet.add((r['C√¢mara']||'').trim());
      if (r.Ato)        atoSet.add((r.Ato||'').trim());
    });

    // Atualiza info do dataset
    const ds = document.getElementById('datasetInfo');
    ds.textContent = `${totalPesquisaveis} linha${totalPesquisaveis!==1?'s':''} dispon√≠veis para pesquisa ‚Ä¢ √öltima atualiza√ß√£o do banco de dados: ${maxDateBr || 'N/I'}`;

    populateSelect('relator', relSet);
    populateSelect('camera', cameraSet);
    populateSelect('ato', atoSet);

    // Monta blocos (somente linhas pesquis√°veis)
    const cont = document.getElementById('allBlocks');
    rows.forEach((r) => {
      if (!r['Publica√ß√£o'] || !r.Ementa) return;

      const proc = (r['Processo'] || '').trim();
      const cam  = (r['C√¢mara'] || '').trim();
      const rel  = cleanRelator(r.Relator || '');
      const ato  = (r.Ato || '').trim();
      const pub  = (r['Publica√ß√£o'] || '').trim();
      const iso  = toISO(pub);
      const eme  = (r.Ementa || '').trim();

      const div = document.createElement('div');
      div.className = 'block';
      div.dataset.date    = iso;
      div.dataset.relator = normalizeStr(rel);
      div.dataset.camera  = normalizeStr(cam);
      div.dataset.ato     = normalizeStr(ato);
      div.innerHTML = `
        <p><strong>Processo: ${proc || 's/ n¬∫'}</strong></p>
        <p>${eme}</p>
        <p class="type">${ato || 'N/I'}</p>
        <p class="meta">(TJGO, ${proc || 's/ n¬∫'}, Rel(a). ${rel || 'N/I'}, ${cam || 'N/I'}, Publicado em ${pub})</p>
      `;
      attachCopyButton(div);
      cont.appendChild(div);

      // Texto "limpo" para destaque
      const ementaEl = div.querySelector('p:nth-of-type(2)');
      const metaEl   = div.querySelector('.meta');
      if (ementaEl && !ementaEl.dataset.original) ementaEl.dataset.original = ementaEl.textContent;
      if (metaEl   && !metaEl.dataset.original)   metaEl.dataset.original   = metaEl.textContent;
    });

    allBlocks = [...document.querySelectorAll('#allBlocks .block')];
    currentResults = [];
    hideResultsUI();

  } catch (e) {
    console.error('Erro ao carregar TSV', e);
    document.getElementById('datasetInfo').textContent = 'N√£o foi poss√≠vel carregar o banco de dados.';
  }
}

function populateSelect(id, set) {
  const sel = document.getElementById(id);
  [...set].sort().forEach((v) => {
    const o = document.createElement('option');
    o.value = v;
    o.textContent = v;
    sel.appendChild(o);
  });
}

/* ---------- UI ---------- */
function hideResultsUI() {
  document.getElementById('resultCount').style.display = 'none';
  document.getElementById('allBlocks').style.display = 'none';
  document.getElementById('pagination').style.display = 'none';
}
function showResultsUI() {
  document.getElementById('resultCount').style.display = 'block';
  document.getElementById('allBlocks').style.display = 'block';
  document.getElementById('pagination').style.display = 'flex';
}
function updateResultCount() {
  const count = currentResults.length;
  const el = document.getElementById('resultCount');
  const plural = count !== 1 ? 's' : '';
  el.textContent = `${count} linha${plural} localizada${plural}`;
  el.style.display = 'block';
}

/* ---------- Busca ---------- */
function performSearch() {
  const raw   = document.getElementById('terms').value.trim();
  const start = document.getElementById('startDate').value;
  const end   = document.getElementById('endDate').value;
  const relF  = normalizeStr(document.getElementById('relator').value);
  const camF  = normalizeStr(document.getElementById('camera').value);
  const atoF  = normalizeStr(document.getElementById('ato').value);
  const clauses = parseSearchQuery(raw);

  currentResults = allBlocks.filter((block) => {
    const rawText = block.textContent || '';
    const text = normalizeStr(rawText);
    const date = block.dataset.date;
    const rel  = block.dataset.relator;
    const cam  = block.dataset.camera;
    const ato  = block.dataset.ato;

    if (start && date < start) return false;
    if (end   && date > end)   return false;
    if (relF  && rel  !== relF) return false;
    if (camF  && cam  !== camF) return false;
    if (atoF  && ato  !== atoF) return false;

    if (!clauses.length) return true;

    return clauses.some(clause => {
      const allMust = clause.must.every(fn => fn(text));
      const noneNot = clause.not.every(fn => !fn(text));
      return allMust && noneNot;
    });
  });

  currentPage = 1;
  updateResultCount();
  renderPage();
  showResultsUI();
}

/* ---------- Destaque (acento-insens√≠vel; respeita *) ---------- */
function highlightText(baseText, terms) {
  if (!terms || !terms.length) return baseText;

  // Normaliza
  const normalize = (str) => (str||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

  let html = baseText;
  const ordered = [...terms].sort((a,b)=>b.length - a.length);

  ordered.forEach(term => {
    if (!term) return;
    const base = term; // aqui usamos o termo como veio; regex cuidar√° do *
    // Constr√≥i regex acento-insens√≠vel com suporte a * e espa√ßos flex√≠veis
    const norm = normalize(base);
    const parts = norm.split('*').map(p => p.replace(/\s+/g,'\\s+').split('').map(ch=>escapeRegex(ch)).join(''));
    // curinga entre partes: [\s\S]*? (qualquer coisa, n√£o ganancioso)
    const body = parts.join('[\\s\\S]*?');
    // mapeia letras com acento: substitu√≠mos classes simples no CORPO j√° escapado
    const withClasses = body
      .replace(/a/gi,'[a√†√°√¢√£√§]')
      .replace(/e/gi,'[e√®√©√™√´]')
      .replace(/i/gi,'[i√¨√≠√Æ√Ø]')
      .replace(/o/gi,'[o√≤√≥√¥√µ√∂]')
      .replace(/u/gi,'[u√π√∫√ª√º]')
      .replace(/c/gi,'[c√ß]');

    const pattern = new RegExp(withClasses, 'gi');
    html = html.replace(pattern, m => `<mark>${m}</mark>`);
  });

  return html;
}

/* ---------- Renderiza√ß√£o e pagina√ß√£o ---------- */
function renderPage() {
  document.querySelectorAll('#allBlocks .block').forEach((b) => (b.style.display = 'none'));

  const totalPages = Math.max(1, Math.ceil(currentResults.length / PAGE_SIZE));
  const startIdx = (currentPage - 1) * PAGE_SIZE;

  // Termos para destaque a partir da mesma sintaxe de busca
  const searchRaw = document.getElementById('terms').value.trim();
  const clausesForHL = parseSearchQuery(searchRaw);
  const termsForHL = extractTermsForHighlight(clausesForHL);

  currentResults.slice(startIdx, startIdx + PAGE_SIZE).forEach((b) => {
    const ementaEl = b.querySelector('p:nth-of-type(2)');
    const metaEl   = b.querySelector('.meta');

    if (ementaEl && ementaEl.dataset.original){
      ementaEl.innerHTML = highlightText(ementaEl.dataset.original, termsForHL);
    }
    if (metaEl && metaEl.dataset.original){
      metaEl.innerHTML   = highlightText(metaEl.dataset.original, termsForHL);
    }

    b.style.display = 'block';
  });

  renderPagination(totalPages);
}

function renderPagination(total) {
  const pag = document.getElementById('pagination');
  pag.innerHTML = '';

  if (total <= 1) { pag.style.display = 'none'; return; }
  pag.style.display = 'flex';

  const addBtn = (label, page, disabled=false, isActive=false) => {
    const btn = document.createElement('button');
    btn.textContent = label;
    if (isActive) btn.classList.add('active');
    if (disabled) btn.setAttribute('disabled','disabled');
    btn.onclick = () => {
      if (!disabled && page !== currentPage) {
        currentPage = page;
        renderPage();
      }
    };
    pag.appendChild(btn);
  };

  addBtn('¬´ Primeira', 1, currentPage === 1);
  addBtn('‚Äπ Anterior', Math.max(1, currentPage - 1), currentPage === 1);

  const half = Math.floor(MAX_PAGE_BUTTONS / 2);
  let start = Math.max(1, currentPage - half);
  let end = Math.min(total, start + MAX_PAGE_BUTTONS - 1);
  if (end - start + 1 < MAX_PAGE_BUTTONS) {
    start = Math.max(1, end - MAX_PAGE_BUTTONS + 1);
  }

  for (let i = start; i <= end; i++) {
    addBtn(String(i), i, false, i === currentPage);
  }

  addBtn('Pr√≥xima ‚Ä∫', Math.min(total, currentPage + 1), currentPage === total);
  addBtn('√öltima ¬ª', total, currentPage === total);
}

window.onload = loadTSV;
</script>
</body>
</html>
